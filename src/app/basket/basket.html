<ng-container *ngIf="currentBasket as basket; else emptyBasket">
  <mat-card class="basket-container mat-elevation-z4">
    <mat-card-title>üß∫ Tvoja korpa</mat-card-title>


    <div class="basket-items" *ngIf="reservedItems.length > 0">
      <div class="basket-item" *ngFor="let item of reservedItems">
        <img class="toy-image" [src]="getToyImage(item.toyId)" alt="Toy image"/>
        <div class="item-details">
          <h4>{{ getToyDetails(item.toyId)?.name || 'Uƒçitavanje...' }}</h4>
          <p>{{ getToyDetails(item.toyId)?.description || 'Uƒçitavanje...' }}</p>
          <p class="status">Status: {{ item.status }}</p>
          <p><strong>Cena:</strong> {{ item.price | number:'1.0-2' }} RSD</p>

          <div class="quantity-controls">
            <button mat-mini-fab color="warn" (click)="updateQuantity(item, item.numOfProd - 1)">
              <mat-icon>remove</mat-icon>
            </button>
            <input type="number" min="1" max="99" [(ngModel)]="item.numOfProd" (change)="updateQuantity(item, item.numOfProd)" />
            <button mat-mini-fab color="primary" (click)="updateQuantity(item, item.numOfProd + 1)">
              <mat-icon>add</mat-icon>
            </button>
          </div>

          <div class="status-controls">
            <button mat-stroked-button color="warn" (click)="changeToCancel(item)">Cancel</button>
            <button mat-stroked-button color="primary" (click)="changeToArrived(item)">Arrived</button>
          </div>
        </div>
      </div>
    </div>


    <div *ngIf="hasArrivedItems" class="arrived-items">
      <h3>Arrived toys:</h3>
      <div class="basket-item" *ngFor="let item of arrivedItems">
        <img class="toy-image" [src]="getToyImage(item.toyId)" alt="Toy image" />
        <div class="item-details">
          <h4>{{ getToyDetails(item.toyId)?.name }}</h4>
          <p>{{ getToyDetails(item.toyId)?.description }}</p>
          <p>Status: {{ item.status }}</p>

          <div *ngIf="!hasUserReviewed(item.toyId, activeUserEmail)" class="rating-section">
            <p><strong>Review toy:</strong></p>
            <div class="stars">
              <mat-icon *ngFor="let star of stars" (click)="selectRating(item.toyId, star)" [class.filled]="star <= (ratings[item.toyId] || 0)">
                star
              </mat-icon>
            </div>
            <button mat-raised-button color="primary" (click)="submitReview(item.toyId)" [disabled]="!ratings[item.toyId]">
              Po≈°alji ocenu
            </button>
          </div>

          <div *ngIf="hasUserReviewed(item.toyId, activeUserEmail)">
            <p><strong>You already gave a review</strong></p>
          </div>

          <button mat-icon-button color="warn" class="remove-item-btn" (click)="removeItem(item)">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>
    </div>

<div *ngIf="hasCanceledItems" class="canceled-items">
  <h3>Canceled toys:</h3>
  <div class="basket-item" *ngFor="let item of canceledItems">
    <img class="toy-image" [src]="getToyImage(item.toyId)" alt="Toy image" />
    <div class="item-details">
      <h4>{{ getToyDetails(item.toyId)?.name }}</h4>
      <p>{{ getToyDetails(item.toyId)?.description }}</p>
      <p>Status: {{ item.status }}</p>
      <button mat-icon-button color="warn" class="remove-item-btn" (click)="removeItem(item)">
            <mat-icon>close</mat-icon>
          </button>
    </div>
  </div>
</div>


    <mat-card-content class="basket-summary">
      <h4>Total : {{ basket.totalPrice | number:'1.0-2' }} RSD</h4>
      <p><strong>Number of items:</strong> {{ basket.totalItemCount }}</p>
    </mat-card-content>
  </mat-card>
</ng-container>

<ng-template #emptyBasket>
  <p class="empty-basket">Your bag is empty</p>
</ng-template>
